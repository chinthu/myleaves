<div class="settings-container">
    <p-toast></p-toast>

    <div class="header">
        <h1>Leave Allocation Settings</h1>
        <p>Configure default leave balances for your organization</p>
    </div>

    <div class="content-grid">
        <!-- Configuration Card -->
        <p-card styleClass="settings-card">
            <div class="card-header">
                <h2>Default Configuration</h2>

                <div class="controls">
                    <div class="control-group" *ngIf="isSuperAdmin">
                        <label>Organization</label>
                        <ng-select [items]="organizations" [(ngModel)]="selectedOrgId" bindLabel="name"
                            bindValue="id" (change)="onOrgChange()" [style]="{'width':'200px'}"></ng-select>
                    </div>

                    <div class="control-group">
                        <label>Year</label>
                        <ng-select [items]="years" [(ngModel)]="settings.year" bindLabel="label" bindValue="value" (change)="loadSettings()"
                            [style]="{'width':'120px'}"></ng-select>
                    </div>
                </div>
            </div>

            <div class="form-grid">
                <div class="form-item">
                    <label>Casual Leaves (CL)</label>
                    <p-inputNumber [(ngModel)]="settings.default_casual_leaves" [showButtons]="true" [min]="0"
                        [max]="50" buttonLayout="horizontal" inputId="cl" spinnerMode="horizontal" [step]="1"
                        decrementButtonClass="p-button-secondary" incrementButtonClass="p-button-secondary"
                        incrementButtonIcon="pi pi-plus" decrementButtonIcon="pi pi-minus">
                    </p-inputNumber>
                    <small>Default annual quota for casual leaves</small>
                </div>

                <div class="form-item">
                    <label>Medical Leaves (ML)</label>
                    <p-inputNumber [(ngModel)]="settings.default_medical_leaves" [showButtons]="true" [min]="0"
                        [max]="50" buttonLayout="horizontal" inputId="ml" spinnerMode="horizontal" [step]="1"
                        decrementButtonClass="p-button-secondary" incrementButtonClass="p-button-secondary"
                        incrementButtonIcon="pi pi-plus" decrementButtonIcon="pi pi-minus">
                    </p-inputNumber>
                    <small>Default annual quota for medical leaves</small>
                </div>
            </div>

            <div class="actions-footer">
                <p-button label="Save Settings" icon="pi pi-save" (onClick)="saveSettings()"
                    [loading]="loading"></p-button>
            </div>
        </p-card>

        <!-- Carry Forward Settings Card (Available to Admin and Super Admin) -->
        <p-card styleClass="settings-card" *ngIf="isAdmin || isSuperAdmin">
            <div class="card-header">
                <h2>Carry Forward Settings</h2>
                <span class="badge-info">Admin & Super Admin Only</span>
            </div>

            <div style="margin-bottom: 1rem;">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <p-checkbox [(ngModel)]="settings.carry_forward_enabled" inputId="carryForward" 
                        [binary]="true" [disabled]="true"></p-checkbox>
                    <label for="carryForward" style="cursor: default; margin: 0;">
                        <strong>Leave Carry Forward</strong>
                        <span *ngIf="settings.carry_forward_enabled" style="color: #48bb78; margin-left: 0.5rem;">(Enabled)</span>
                        <span *ngIf="!settings.carry_forward_enabled" style="color: #f56565; margin-left: 0.5rem;">(Disabled)</span>
                    </label>
                </div>
                <small style="margin-left: 1.75rem; display: block; color: #6B6B6B;">
                    If enabled, remaining casual leaves from previous year will be added to the new annual quota during year-end processing. 
                    Medical leaves will always reset to default annual quota regardless of this setting. 
                    If disabled, all users will start with only the default annual quota.
                </small>
            </div>

            <div class="actions-footer">
                <p-button 
                    [label]="settings.carry_forward_enabled ? 'Disable Carry Forward' : 'Enable Carry Forward'" 
                    [icon]="settings.carry_forward_enabled ? 'pi pi-times' : 'pi pi-check'" 
                    styleClass="p-button-warning"
                    (onClick)="toggleCarryForward()" 
                    [loading]="loading">
                </p-button>
            </div>
        </p-card>

        <!-- Year-End Processing Card -->
        <p-card styleClass="settings-card" *ngIf="canProcessYearEnd">
            <div class="card-header">
                <h2>Year-End Processing</h2>
                <span class="badge-warning">Available in First Week of January</span>
            </div>

            <p>
                <strong>Process Year-End for {{settings.year - 1}}:</strong> This will:
            </p>
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                <li>Archive all leaves from {{settings.year - 1}} (locked, non-editable)</li>
                <li *ngIf="settings.carry_forward_enabled">
                    Carry forward remaining casual leaves and add new annual quota (medical leaves will reset to default)
                </li>
                <li *ngIf="!settings.carry_forward_enabled">
                    Reset all user balances to default annual quota only
                </li>
                <li>Medical leaves always reset to default annual quota</li>
                <li>Create archive records for historical tracking</li>
            </ul>
            <p style="color: #ed8936; font-weight: 600; margin-top: 0.5rem;">
                This action CANNOT be undone!
            </p>

            <div class="actions-footer">
                <p-button label="Process Year-End & Reset Quota" icon="pi pi-calendar-check" styleClass="p-button-warning"
                    (onClick)="processYearEnd()" [loading]="loading"></p-button>
            </div>
        </p-card>

        <!-- Bulk Actions Card -->
        <p-card styleClass="settings-card danger-zone">
            <div class="card-header">
                <h2>Bulk Actions</h2>
                <span class="badge-danger">Danger Zone</span>
            </div>

            <p>
                <strong>Warning:</strong> This will permanently delete ALL leaves (pending, approved, cancelled) and reset all leave balances to default values for all users in the selected organization.
            </p>
            <p style="color: #f56565; font-weight: 600; margin-top: 0.5rem;">
                This action CANNOT be undone!
            </p>

            <div class="actions-footer">
                <p-button label="Reset All Leaves & Balances" icon="pi pi-refresh" styleClass="p-button-danger"
                    (onClick)="bulkUpdateUsers()" [loading]="loading"></p-button>
            </div>
            <p-confirmDialog></p-confirmDialog>
        </p-card>
    </div>
</div>
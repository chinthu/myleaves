<div class="apply-leave-container p-4">
    <p-toast></p-toast>
    <p-card header="Apply for Leave" styleClass="w-full shadow-2">
        <form (ngSubmit)="submitLeave()" class="flex flex-column gap-4">

            <!-- Leave Type -->
            <div class="flex flex-column gap-2">
                <label class="font-bold text-900">Leave Type <span class="text-red-500">*</span></label>
                <div class="flex flex-wrap gap-4">
                    <div class="field-radiobutton flex align-items-center">
                        <p-radioButton name="leaveType" value="CASUAL" [(ngModel)]="leaveType"
                            inputId="lt1"></p-radioButton>
                        <label for="lt1" class="ml-2 cursor-pointer">Casual Leave</label>
                    </div>
                    <div class="field-radiobutton flex align-items-center">
                        <p-radioButton name="leaveType" value="MEDICAL" [(ngModel)]="leaveType"
                            inputId="lt2"></p-radioButton>
                        <label for="lt2" class="ml-2 cursor-pointer">Medical Leave</label>
                    </div>
                    <div class="field-radiobutton flex align-items-center" *ngIf="canApplyCompOff">
                        <p-radioButton name="leaveType" value="COMP_OFF" [(ngModel)]="leaveType"
                            inputId="lt3"></p-radioButton>
                        <label for="lt3" class="ml-2 cursor-pointer">Comp Off</label>
                    </div>
                </div>
            </div>

            <!-- Duration Type -->
            <div class="flex flex-column gap-2">
                <label class="font-bold text-900">Duration <span class="text-red-500">*</span></label>
                <div class="flex flex-wrap gap-4">
                    <div class="field-radiobutton flex align-items-center">
                        <p-radioButton name="duration" value="FULL_DAY" [(ngModel)]="duration" inputId="d1"
                            (onClick)="calculateDays()"></p-radioButton>
                        <label for="d1" class="ml-2 cursor-pointer">Full Day</label>
                    </div>
                    <div class="field-radiobutton flex align-items-center">
                        <p-radioButton name="duration" value="HALF_DAY" [(ngModel)]="duration" inputId="d2"
                            (onClick)="calculateDays()"></p-radioButton>
                        <label for="d2" class="ml-2 cursor-pointer">Half Day</label>
                    </div>
                    <div class="field-radiobutton flex align-items-center">
                        <p-radioButton name="duration" value="LONG_LEAVE" [(ngModel)]="duration" inputId="d3"
                            (onClick)="calculateDays()"></p-radioButton>
                        <label for="d3" class="ml-2 cursor-pointer">Long Leave</label>
                    </div>
                </div>
            </div>

            <!-- Date Selection Note -->
            <div class="p-2 bg-yellow-50 border-round text-yellow-800 mb-2" style="border-left: 3px solid #ed8936; font-size: 0.75rem;">
                <i class="pi pi-info-circle mr-1" style="font-size: 0.875rem;"></i>
                <span><strong>Note:</strong> Leave can only be applied for dates starting from {{minDate | date:'MMM d, y'}} (one month before today). Dates before this cannot be selected.</span>
            </div>
            
            <div *ngIf="duration === 'HALF_DAY'" class="grid formgrid">
                <div class="col-12 md:col-6 flex flex-column gap-2">
                    <label class="font-bold text-900">Select Date <span class="text-red-500">*</span></label>
                    <p-calendar [(ngModel)]="halfDayDate" name="halfDayDate" [showIcon]="true" dataType="string"
                        dateFormat="yy-mm-dd" [minDate]="minDate" styleClass="w-full" inputStyleClass="w-full" required></p-calendar>
                </div>
                <div class="col-12 md:col-6 flex flex-column gap-2">
                    <label class="font-bold text-900">Select Slot <span class="text-red-500">*</span></label>
                    <ng-select
                        [items]="[{label: 'Morning (First Half)', value: 'MORNING'}, {label: 'Afternoon (Second Half)', value: 'AFTERNOON'}]"
                        [(ngModel)]="halfDaySlot" name="halfDaySlot" bindLabel="label" bindValue="value"
                        [clearable]="false"
                        [style]="{width: '100%'}" placeholder="Select Slot" required></ng-select>
                </div>
            </div>

            <div *ngIf="duration === 'FULL_DAY'" class="flex flex-column gap-2">
                <label class="font-bold text-900">Select Date <span class="text-red-500">*</span></label>
                <p-calendar [(ngModel)]="startDate" name="startDate" [showIcon]="true" (onSelect)="calculateDays()"
                    dataType="string" dateFormat="yy-mm-dd" [minDate]="minDate" styleClass="w-full" inputStyleClass="w-full" required></p-calendar>
            </div>

            <div *ngIf="duration === 'LONG_LEAVE'" class="grid formgrid">
                <div class="col-12 md:col-6 flex flex-column gap-2">
                    <label class="font-bold text-900">Start Date <span class="text-red-500">*</span></label>
                    <p-calendar [(ngModel)]="startDate" name="startDate" [showIcon]="true" (onSelect)="onStartDateChange()"
                        dataType="string" dateFormat="yy-mm-dd" [minDate]="minDate" styleClass="w-full"
                        inputStyleClass="w-full" required></p-calendar>
                </div>
                <div class="col-12 md:col-6 flex flex-column gap-2">
                    <label class="font-bold text-900">End Date <span class="text-red-500">*</span></label>
                    <p-calendar [(ngModel)]="endDate" name="endDate" [showIcon]="true" (onSelect)="calculateDays()"
                        dataType="string" dateFormat="yy-mm-dd" [minDate]="getMinDateForEndDate()" styleClass="w-full"
                        inputStyleClass="w-full" required></p-calendar>
                    <small *ngIf="startDate && endDate" class="text-500">
                        <span *ngIf="isEndDateBeforeStartDate()" class="text-red-500">
                            <i class="pi pi-exclamation-triangle mr-1"></i>End date cannot be less than start date.
                        </span>
                    </small>
                </div>
            </div>

            <!-- Days Count Display -->
            <div class="p-3 bg-blue-50 border-round text-blue-700 font-bold flex align-items-center">
                <i class="pi pi-info-circle mr-2"></i>
                <span>Total Days: {{ daysCount }}</span>
            </div>

            <!-- Reason -->
            <div class="flex flex-column gap-2">
                <label class="font-bold text-900">Reason <span class="text-red-500">*</span></label>
                <textarea pInputTextarea [(ngModel)]="reason" name="reason" rows="3"
                    placeholder="Enter reason for leave" class="w-full" required></textarea>
            </div>

            <!-- Approval Group -->
            <div class="flex flex-column gap-2">
                <label class="font-bold text-900">Assign to Approval Team <span class="text-red-500">*</span></label>
                <ng-select [items]="groups" [(ngModel)]="selectedGroupId" name="selectedGroupId" bindLabel="name"
                    bindValue="id" [clearable]="false" placeholder="Select a group" [style]="{width: '100%'}" required></ng-select>
            </div>

            <div class="flex justify-content-end gap-3 mt-4">
                <p-button label="Cancel" styleClass="p-button-secondary p-button-outlined" routerLink="/"></p-button>
                <p-button label="Submit Request" type="submit" [loading]="loading"></p-button>
            </div>

        </form>
    </p-card>
</div>
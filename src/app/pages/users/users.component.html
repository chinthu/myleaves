<div class="users-container">
    <p-toast></p-toast>
    <div class="header mb-4">
        <div class="flex justify-content-between align-items-center">
            <div class="flex gap-3 align-items-center">
                <h2 class="m-0">User Management</h2>
                <p *ngIf="isApprover" class="text-muted m-0" style="font-size: 0.875rem;">
                    Showing users from your approval groups
                </p>
                <ng-select *ngIf="isSuperAdmin" [items]="organizations" [(ngModel)]="selectedOrgId" bindLabel="name"
                    bindValue="id" (change)="onOrgChange()" placeholder="Select Organization"
                    [style]="{width: '15rem'}">
                </ng-select>
            </div>
            <div class="flex gap-2 align-items-center">
                <button pButton [label]="showLeaveStats ? 'Hide Leave Stats' : 'View Leave Stats'"
                    [icon]="showLeaveStats ? 'pi pi-eye-slash' : 'pi pi-eye'" (click)="toggleLeaveStats()"
                    styleClass="p-button-outlined" *ngIf="!isApprover"></button>
                <button pButton label="Add User" icon="pi pi-plus" (click)="openAddModal()"
                    *ngIf="!isApprover"></button>
            </div>
        </div>
    </div>

    <!-- Leave Stats View -->
    <div *ngIf="showLeaveStats" class="card mb-4">
        <div class="flex justify-content-between align-items-center mb-3">
            <h3 class="m-0">Leave Statistics ({{ selectedYear }})</h3>
            <ng-select [(ngModel)]="selectedYear" [items]="availableYears" bindLabel="label" bindValue="value"
                (change)="onYearChange()" [style]="{width: '120px'}">
            </ng-select>
        </div>
        <p-table [value]="userLeaveStats" [loading]="loadingStats" [rows]="10" [paginator]="true"
            responsiveLayout="scroll">
            <ng-template pTemplate="header">
                <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Applied</th>
                    <th>Pending</th>
                    <th>Approved</th>
                    <th>Rejected</th>
                    <th>Casual Taken</th>
                    <th>Medical Taken</th>
                    <th>Comp Off Taken</th>
                    <th>Total Days</th>
                    <th>Remaining Casual</th>
                    <th>Remaining Medical</th>
                    <th>Remaining Comp Off</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-user>
                <tr>
                    <td>{{ user.full_name }}</td>
                    <td>{{ user.email }}</td>
                    <td>{{ user.total_applied }}</td>
                    <td><p-tag [value]="user.pending" severity="warning"></p-tag></td>
                    <td><p-tag [value]="user.approved" severity="success"></p-tag></td>
                    <td><p-tag [value]="user.rejected" severity="danger"></p-tag></td>
                    <td>{{ user.casual_leaves_taken }}</td>
                    <td>{{ user.medical_leaves_taken }}</td>
                    <td>{{ user.comp_off_leaves_taken }}</td>
                    <td><strong>{{ user.total_days_taken }}</strong></td>
                    <td><strong>{{ user.balance_casual }}</strong></td>
                    <td><strong>{{ user.balance_medical }}</strong></td>
                    <td><strong>{{ user.remaining_comp_offs || 0 }}</strong></td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td colspan="13" class="text-center p-4">No leave statistics available.</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <div class="card">
        <p-table [value]="users" [loading]="loading" [rows]="10" [paginator]="true" responsiveLayout="scroll"
            [globalFilterFields]="['full_name', 'email', 'role']">
            <ng-template pTemplate="header">
                <tr>
                    <th pSortableColumn="full_name">Name <p-sortIcon field="full_name"></p-sortIcon></th>
                    <th pSortableColumn="email">Email <p-sortIcon field="email"></p-sortIcon></th>
                    <th pSortableColumn="role">Role <p-sortIcon field="role"></p-sortIcon></th>
                    <th pSortableColumn="designation">Designation <p-sortIcon field="designation"></p-sortIcon></th>
                    <th *ngIf="!isApprover">Actions</th>
                    <th *ngIf="isApprover">Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-user>
                <tr>
                    <td>{{ user.full_name }}</td>
                    <td>{{ user.email }}</td>
                    <td><p-tag [value]="user.role" [severity]="getRoleSeverity(user.role)"></p-tag></td>
                    <td>{{ user.designation || '-' }}</td>
                    <td>
                        <div class="flex gap-2">
                            <button pButton icon="pi pi-info-circle" class="p-button-rounded p-button-text"
                                (click)="viewUserDashboard(user)" pTooltip="View Dashboard"></button>
                            <button *ngIf="!isApprover" pButton icon="pi pi-pencil"
                                class="p-button-rounded p-button-text" (click)="openEditModal(user)"
                                pTooltip="Edit User"></button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td [attr.colspan]="isApprover ? 5 : 5" class="text-center p-4">
                        <div *ngIf="isApprover && approvalGroupIds.length === 0">
                            <p>You are not assigned to any approval groups.</p>
                            <p class="text-muted">Contact your administrator to be added to an approval group.</p>
                        </div>
                        <div *ngIf="!isApprover || approvalGroupIds.length > 0">
                            No users found.
                        </div>
                    </td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <!-- Modal -->
    <p-dialog [(visible)]="showModal" [header]="isEditing ? 'Edit User' : 'Add New User'" [modal]="true"
        [style]="{width: '450px'}" [draggable]="false" [resizable]="false" styleClass="p-fluid">

        <div class="field">
            <label for="full_name">Full Name</label>
            <input pInputText id="full_name" [(ngModel)]="formData.full_name" required />
        </div>

        <div class="field mt-3">
            <label for="email">Email</label>
            <input pInputText id="email" type="email" [(ngModel)]="formData.email" [disabled]="isEditing" required />
        </div>

        <div class="field mt-3" *ngIf="!isEditing">
            <label for="password">Password</label>
            <input pInputText id="password" type="password" [(ngModel)]="formData.password" required />
        </div>

        <div class="field mt-3">
            <label for="role">Role</label>
            <ng-select id="role" [items]="roles" [(ngModel)]="formData.role" bindLabel="label" bindValue="value"
                [clearable]="true" placeholder="Select Role" appendTo="body"></ng-select>
        </div>

        <div class="field mt-3">
            <label for="designation">Designation</label>
            <input pInputText id="designation" [(ngModel)]="formData.designation" />
        </div>

        <ng-template pTemplate="footer">
            <button pButton label="Cancel" icon="pi pi-times" class="p-button-text" (click)="closeModal()"></button>
            <button pButton label="Save" icon="pi pi-check" (click)="saveUser()" [loading]="loading"></button>
        </ng-template>
    </p-dialog>
</div>
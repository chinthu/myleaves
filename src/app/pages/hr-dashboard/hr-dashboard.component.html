<div class="hr-dashboard-wrapper">
    <div class="dashboard-header">
        <h1>HR Dashboard</h1>
        <p>Comprehensive leave management analytics and insights</p>
    </div>

    <!-- Quick Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <i class="pi pi-users"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{totalUsers}}</div>
                <div class="stat-label">Total Employees</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <i class="pi pi-calendar-times"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{todayStats.total}}</div>
                <div class="stat-label">On Leave Today</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #fad0c4 0%, #ffd1ff 100%);">
                <i class="pi pi-clock"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{pendingRequests}}</div>
                <div class="stat-label">Pending Approvals</div>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);">
                <i class="pi pi-exclamation-triangle"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">{{lowBalanceUsers}}</div>
                <div class="stat-label">Low Balance Alerts</div>
            </div>
        </div>

        <div class="stat-card" *ngIf="usersWithExcessCasual > 0" style="border-left: 4px solid #dc2626;">
            <div class="stat-icon" style="background: linear-gradient(135deg, #fecaca 0%, #fee2e2 100%);">
                <i class="pi pi-exclamation-circle" style="color: #dc2626;"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value" style="color: #dc2626;">{{usersWithExcessCasual}}</div>
                <div class="stat-label">Excess Casual Leaves</div>
            </div>
        </div>
    </div>

    <!-- Excess Casual Leaves Section -->
    <div class="section-card" *ngIf="usersWithExcessCasualLeaves.length > 0" style="background: #fef2f2; border-left: 4px solid #dc2626; margin-bottom: 1.5rem;">
        <div class="section-header">
            <h2 style="color: #dc2626; margin: 0;">
                <i class="pi pi-exclamation-triangle"></i> Users with Excess Casual Leaves
            </h2>
            <p style="color: #7f1d1d; margin: 0.5rem 0 0 0; font-size: 0.875rem;">
                Employees who have taken casual leaves after their available balance became zero
            </p>
        </div>

        <p-table [value]="usersWithExcessCasualLeaves" [paginator]="true" [rows]="10" responsiveLayout="scroll" styleClass="p-datatable-sm">
            <ng-template pTemplate="header">
                <tr>
                    <th>Employee</th>
                    <th>Total Excess Days</th>
                    <th>Balance Reached Zero</th>
                    <th>Monthly Breakdown</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-user>
                <tr>
                    <td>
                        <div class="employee-cell">
                            <div class="employee-avatar">{{user.full_name?.charAt(0) || 'U'}}</div>
                            <div>
                                <div class="font-medium">{{user.full_name || user.email}}</div>
                                <div class="text-sm text-500">{{user.email}}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span style="font-weight: 600; color: #dc2626; font-size: 1.1rem;">
                            {{user.excessTotal}} {{user.excessTotal === 1 ? 'day' : 'days'}}
                        </span>
                    </td>
                    <td>
                        <span *ngIf="user.zeroBalanceDate" style="color: #991b1b;">
                            {{user.zeroBalanceDate | date:'MMM d, y'}}
                        </span>
                        <span *ngIf="!user.zeroBalanceDate" style="color: #6B6B6B;">-</span>
                    </td>
                    <td>
                        <div *ngIf="user.monthlyBreakdown && user.monthlyBreakdown.length > 0" 
                             style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            <span *ngFor="let month of user.monthlyBreakdown" 
                                  style="padding: 0.25rem 0.5rem; background: white; border-radius: 4px; border: 1px solid #fecaca; font-size: 0.875rem;">
                                <strong>{{month.month}}:</strong> {{month.days}} {{month.days === 1 ? 'day' : 'days'}}
                            </span>
                        </div>
                        <span *ngIf="!user.monthlyBreakdown || user.monthlyBreakdown.length === 0" style="color: #6B6B6B;">-</span>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td [attr.colspan]="4" class="text-center p-4">No users with excess casual leaves</td>
                </tr>
            </ng-template>
        </p-table>
    </div>

    <!-- Today's Leaves Section -->
    <div class="section-card">
        <div class="section-header">
            <h2>Who's On Leave Today</h2>
            <div class="today-breakdown">
                <span class="breakdown-item"><span class="badge badge-casual">{{todayStats.casual}}</span> Casual</span>
                <span class="breakdown-item"><span class="badge badge-medical">{{todayStats.medical}}</span>
                    Medical</span>
                <span class="breakdown-item"><span class="badge badge-compoff">{{todayStats.compOff}}</span>
                    Comp-off</span>
            </div>
        </div>

        <div class="today-leaves-grid" *ngIf="todaysLeaves.length > 0">
            <div class="leave-card" *ngFor="let leave of todaysLeaves">
                <div class="leave-avatar">{{leave.users?.full_name?.charAt(0) || 'U'}}</div>
                <div class="leave-details">
                    <div class="leave-name">{{leave.users?.full_name || leave.users?.email}}</div>
                    <div class="leave-info">
                        <span [class]="getTypeBadgeClass(leave.type)">{{leave.type}}</span>
                        <span class="leave-duration" *ngIf="leave.is_half_day">
                            {{leave.half_day_slot === 'MORNING' ? 'First Half' : 'Second Half'}}
                        </span>
                        <span class="leave-duration" *ngIf="!leave.is_half_day">Full Day</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="empty-state" *ngIf="todaysLeaves.length === 0">
            <i class="pi pi-check-circle"></i>
            <p>Everyone is present today!</p>
        </div>
    </div>

    <!-- Analytics Charts -->
    <div class="charts-grid">
        <div class="chart-card">
            <h3>Leave Type Distribution</h3>
            <p-chart type="pie" [data]="leaveTypeChart" [options]="chartOptions"></p-chart>
        </div>

        <div class="chart-card">
            <h3>Leave Status Overview</h3>
            <p-chart type="doughnut" [data]="leaveStatusChart" [options]="chartOptions"></p-chart>
        </div>

        <div class="chart-card">
            <h3>Top Users by Leaves</h3>
            <p-chart type="bar" [data]="topUsersLeavesChart" [options]="topUsersChartOptions"></p-chart>
        </div>

        <div class="chart-card full-width">
            <h3>Leave Trend (Last 6 Months of {{selectedYear}})</h3>
            <p-chart type="line" [data]="leaveTrendChart" [options]="chartOptions"></p-chart>
        </div>
    </div>

    <!-- All Leaves Grid -->
    <div class="section-card">
        <div class="section-header">
            <h2>All Leave Applications</h2>
            <div class="filters-group">
                <ng-select [items]="availableYears" [(ngModel)]="selectedYear" bindLabel="label"
                    bindValue="value" (change)="onYearChange()" placeholder="Select Year" 
                    [style]="{width: '150px'}" [clearable]="false" appendTo="body"></ng-select>

                <ng-select [items]="statusOptions" [(ngModel)]="selectedStatus" bindLabel="label"
                    bindValue="value" (change)="onFilterChange()" placeholder="Status" 
                    [style]="{width: '150px'}" [clearable]="true" appendTo="body"></ng-select>

                <p-button label="Clear Filters" icon="pi pi-filter-slash" styleClass="p-button-outlined"
                    (onClick)="clearFilters()"></p-button>
            </div>
        </div>

        <p-table [value]="filteredLeaves" [paginator]="true" [rows]="10" responsiveLayout="scroll" [loading]="loading">
            <ng-template pTemplate="header">
                <tr>
                    <th>Employee</th>
                    <th>Type</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Days</th>
                    <th>Status</th>
                    <th>Applied On</th>
                    <th *ngIf="isAdmin()">Actions</th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-leave>
                <tr>
                    <td>
                        <div class="employee-cell">
                            <div class="employee-avatar">{{leave.users?.full_name?.charAt(0) || 'U'}}</div>
                            <div>
                                <div class="font-medium">{{leave.users?.full_name || leave.users?.email}}</div>
                                <div class="text-sm text-500">{{leave.users?.email}}</div>
                            </div>
                        </div>
                    </td>
                    <td><span [class]="getTypeBadgeClass(leave.type)">{{leave.type}}</span></td>
                    <td>{{leave.start_date | date:'MMM d, y'}}</td>
                    <td>{{leave.end_date | date:'MMM d, y'}}</td>
                    <td>{{leave.days_count}}</td>
                    <td><p-tag [value]="leave.status" [severity]="getStatusSeverity(leave.status)"></p-tag></td>
                    <td>{{leave.created_at | date:'MMM d, y'}}</td>
                    <td *ngIf="isAdmin()">
                        <div class="flex gap-2">
                            <p-button 
                                icon="pi pi-pencil" 
                                styleClass="p-button-rounded p-button-text p-button-sm"
                                (onClick)="openEditDialog(leave)"
                                pTooltip="Edit Leave">
                            </p-button>
                            <p-button 
                                icon="pi pi-times" 
                                styleClass="p-button-rounded p-button-text p-button-warning p-button-sm"
                                (onClick)="confirmCancel(leave)"
                                pTooltip="Cancel Leave">
                            </p-button>
                            <p-button 
                                icon="pi pi-trash" 
                                styleClass="p-button-rounded p-button-text p-button-danger p-button-sm"
                                (onClick)="confirmDelete(leave)"
                                pTooltip="Delete Leave">
                            </p-button>
                        </div>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage">
                <tr>
                    <td [attr.colspan]="isAdmin() ? 8 : 7" class="text-center p-4">No leave applications found</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<!-- Edit Leave Dialog -->
<p-dialog 
    [(visible)]="showEditDialog" 
    [modal]="true" 
    [style]="{width: '500px'}"
    [draggable]="false"
    [resizable]="false" 
    header="Edit Leave"
    [closable]="true"
    (onHide)="closeEditDialog()">
    <div class="flex flex-column gap-3">
        <div>
            <label class="block mb-2">Leave Type</label>
            <ng-select 
                [(ngModel)]="editForm.type" 
                [items]="leaveTypes" 
                bindLabel="label" 
                bindValue="value"
                [clearable]="true"
                appendTo="body"
                [style]="{width: '100%'}">
            </ng-select>
        </div>
        <div>
            <label class="block mb-2">Start Date</label>
            <p-calendar 
                [(ngModel)]="editForm.start_date" 
                [showIcon]="true"
                dateFormat="yy-mm-dd"
                [style]="{width: '100%'}">
            </p-calendar>
        </div>
        <div>
            <label class="block mb-2">End Date</label>
            <p-calendar 
                [(ngModel)]="editForm.end_date" 
                [showIcon]="true"
                dateFormat="yy-mm-dd"
                [style]="{width: '100%'}">
            </p-calendar>
        </div>
        <div>
            <div class="flex align-items-center gap-2">
                <p-checkbox [(ngModel)]="editForm.is_half_day" inputId="halfDayCheck" [binary]="true" (onChange)="onHalfDayToggle()"></p-checkbox>
                <label for="halfDayCheck" style="cursor: pointer; margin: 0;">Half Day</label>
            </div>
        </div>
        <div *ngIf="editForm.is_half_day">
            <label class="block mb-2">Half Day Slot</label>
            <ng-select 
                [(ngModel)]="editForm.half_day_slot" 
                [items]="halfDaySlots" 
                bindLabel="label" 
                bindValue="value"
                [clearable]="true"
                appendTo="body"
                [style]="{width: '100%'}">
            </ng-select>
        </div>
        <div>
            <label class="block mb-2">Reason</label>
            <textarea 
                [(ngModel)]="editForm.reason" 
                pInputTextarea 
                rows="3"
                [style]="{width: '100%'}">
            </textarea>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" (onClick)="closeEditDialog()" styleClass="p-button-text"></p-button>
        <p-button label="Save" icon="pi pi-check" (onClick)="saveEdit()" styleClass="p-button-primary"></p-button>
    </ng-template>
</p-dialog>

<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>